name: AI Safety Monitor

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      run_type:
        description: 'Type of run'
        required: true
        default: 'standard'
        type: choice
        options:
          - standard
          - verbose
          - debug

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Initialize directories
        run: |
          mkdir -p data logs
          echo "Directories created"

      - name: Download previous history
        id: download-history
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: url-history
          path: ./data/

      - name: Create initial history file
        if: steps.download-history.outcome == 'failure'
        run: |
          echo '{}' > data/url_history.json
          echo "Initial URL history created"

      - name: Run monitoring cycle
        env:
          CHANGEDETECTION_API_KEY: ${{ secrets.CHANGEDETECTION_API_KEY }}
          GOOGLE_SHEETS_USE_ENV: 'true'
          GOOGLE_SHEETS_TYPE: ${{ secrets.GOOGLE_SHEETS_TYPE }}
          GOOGLE_SHEETS_PROJECT_ID: ${{ secrets.GOOGLE_SHEETS_PROJECT_ID }}
          GOOGLE_SHEETS_PRIVATE_KEY_ID: ${{ secrets.GOOGLE_SHEETS_PRIVATE_KEY_ID }}
          GOOGLE_SHEETS_PRIVATE_KEY: ${{ secrets.GOOGLE_SHEETS_PRIVATE_KEY }}
          GOOGLE_SHEETS_CLIENT_EMAIL: ${{ secrets.GOOGLE_SHEETS_CLIENT_EMAIL }}
          GOOGLE_SHEETS_CLIENT_ID: ${{ secrets.GOOGLE_SHEETS_CLIENT_ID }}
          GOOGLE_SHEETS_AUTH_URI: ${{ secrets.GOOGLE_SHEETS_AUTH_URI }}
          GOOGLE_SHEETS_TOKEN_URI: ${{ secrets.GOOGLE_SHEETS_TOKEN_URI }}
          GOOGLE_SHEETS_AUTH_PROVIDER_X509_CERT_URL: ${{ secrets.GOOGLE_SHEETS_AUTH_PROVIDER_X509_CERT_URL }}
          GOOGLE_SHEETS_CLIENT_X509_CERT_URL: ${{ secrets.GOOGLE_SHEETS_CLIENT_X509_CERT_URL }}
          MONITOR_RUN_TYPE: ${{ github.event.inputs.run_type }}
        run: |
          python - <<'PYTHON'
          from monitor import MonitoringService
          service = MonitoringService(config_path="config.yaml")
          stats = service.run_cycle()
          print(f"Cycle {stats.cycle_id} completed: {stats.changes_detected} changes detected")
          PYTHON

      - name: Upload URL history artifact
        uses: actions/upload-artifact@v4
        with:
          name: url-history
          path: data/url_history.json
          retention-days: 30

      - name: Upload monitoring reports
        uses: actions/upload-artifact@v4
        with:
          name: monitoring-reports
          path: data/reports/
          retention-days: 30
          if-no-files-found: ignore

      - name: Upload logs for debugging
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: monitor-logs
          path: logs/
          retention-days: 7
          if-no-files-found: ignore

      - name: Create workflow summary
        if: always()
        run: |
          echo "## AI Safety Monitor Run Complete" >> $GITHUB_STEP_SUMMARY
          echo "- Run Type: ${{ github.event.inputs.run_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Timestamp: $(date -u)" >> $GITHUB_STEP_SUMMARY