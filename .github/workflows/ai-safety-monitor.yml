name: AI Safety Monitor

on:
  schedule:
    - cron: '0 */6 * * *'  # Run every 6 hours
  workflow_dispatch:
    inputs:
      run_type:
        description: 'Type of run'
        required: true
        default: 'standard'
        type: choice
        options:
          - standard
          - verbose
          - debug

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
      # Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # Cache Docker layers
      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-docker-${{ hashFiles('**/Dockerfile') }}
          restore-keys: |
            ${{ runner.os }}-docker-

      # Pull Docker images before building to speed up subsequent builds
      - name: Pull Docker images
        run: docker compose pull

      # Build metadata-monitor image
      - name: Build metadata-monitor image
        run: docker compose build metadata-monitor

      # Bring up dependent services
      - name: Start changedetection.io and Playwright
        run: docker compose up -d changedetection playwright-chrome

      # Wait for changedetection.io to be ready
      - name: Wait for changedetection.io
        run: |
          echo "Waiting for changedetection.io to be ready..."
          for i in {1..12}; do
            if curl -s http://localhost:5000; then
              echo "Changedetection is ready"
              exit 0
            fi
            echo "Waiting for changedetection... attempt $i"
            sleep 10
          done
          echo "Changedetection never became ready"
          exit 1

      # Prepare data and logs directories with write permissions
      - name: Prepare directories
        run: |
          mkdir -p data/reports logs
          chmod -R 777 data logs

      # Run monitoring cycle with retries
      - name: Run monitoring cycle
        run: |
          # Explicit network configuration
          NETWORK_NAME=$(docker compose ps --format json | jq -r '.[0].Project' 2>/dev/null || echo "$(basename $PWD)")_appnet
          echo "Using network: $NETWORK_NAME"

          for attempt in {1..3}; do
            echo "Attempt $attempt to run monitoring container..."
            docker compose run --rm \
              -e GITHUB_ACTIONS=true \
              -e GITHUB_RUN_ID=${{ github.run_id }} \
              -e GITHUB_RUN_ATTEMPT=${{ github.run_attempt }} \
              -e GITHUB_SHA=${{ github.sha }} \
              -e GITHUB_REF=${{ github.ref }} \
              -e CHANGEDETECTION_URL=http://changedetection:5000 \
              -e GOOGLE_SHEETS_USE_ENV=true \
              -e GOOGLE_SHEETS_TYPE=${{ secrets.GOOGLE_SHEETS_TYPE }} \
              -e GOOGLE_SHEETS_PROJECT_ID=${{ secrets.GOOGLE_SHEETS_PROJECT_ID }} \
              -e GOOGLE_SHEETS_PRIVATE_KEY_ID=${{ secrets.GOOGLE_SHEETS_PRIVATE_KEY_ID }} \
              -e GOOGLE_SHEETS_PRIVATE_KEY="${{ secrets.GOOGLE_SHEETS_PRIVATE_KEY }}" \
              -e GOOGLE_SHEETS_CLIENT_EMAIL=${{ secrets.GOOGLE_SHEETS_CLIENT_EMAIL }} \
              -e GOOGLE_SHEETS_CLIENT_ID=${{ secrets.GOOGLE_SHEETS_CLIENT_ID }} \
              -e GOOGLE_SHEETS_AUTH_URI=${{ secrets.GOOGLE_SHEETS_AUTH_URI }} \
              -e GOOGLE_SHEETS_TOKEN_URI=${{ secrets.GOOGLE_SHEETS_TOKEN_URI }} \
              -e GOOGLE_SHEETS_AUTH_PROVIDER_X509_CERT_URL=${{ secrets.GOOGLE_SHEETS_AUTH_PROVIDER_X509_CERT_URL }} \
              -e GOOGLE_SHEETS_CLIENT_X509_CERT_URL=${{ secrets.GOOGLE_SHEETS_CLIENT_X509_CERT_URL }} \
              -e MONITOR_RUN_TYPE=${{ github.event.inputs.run_type }} \
              metadata-monitor python run_monitor.py
            if [ $? -eq 0 ]; then
              echo "Monitoring completed successfully."
              break
            else
              echo "Monitoring failed, retrying in 10s..."
              sleep 10
            fi
          done

      # Upload monitoring reports
      - name: Upload monitoring reports
        uses: actions/upload-artifact@v4
        with:
          name: monitoring-reports
          path: data/reports/
          retention-days: 30
          if-no-files-found: ignore

      # Upload logs
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: monitor-logs
          path: logs/
          retention-days: 7
          if-no-files-found: ignore

      # Tear down services
      - name: Tear down services
        if: always()
        run: docker compose down

      # Workflow summary
      - name: Create workflow summary
        if: always()
        run: |
          echo "## AI Safety Monitor Run Complete" >> $GITHUB_STEP_SUMMARY
          echo "- Run Type: ${{ github.event.inputs.run_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Timestamp: $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "- Run Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- Docker Version: $(docker --version)" >> $GITHUB_STEP_SUMMARY
          echo "- Node Version: $(node --version)" >> $GITHUB_STEP_SUMMARY