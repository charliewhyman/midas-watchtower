name: AI Safety Monitor

on:
  schedule:
    - cron: '0 */6 * * *'  # Run every 6 hours
  workflow_dispatch:
    inputs:
      run_type:
        description: 'Type of run'
        required: true
        default: 'standard'
        type: choice
        options:
          - standard
          - verbose
          - debug

env:
  DOCKER_COMPOSE_PROJECT: ai-safety-monitor-${{ github.run_id }}

jobs:
  monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-docker-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-docker-

      - name: Build and start services
        run: |
          docker compose build metadata-monitor
          docker compose -p $DOCKER_COMPOSE_PROJECT up -d changedetection playwright-chrome

      - name: Wait for basic connectivity
        run: |
          echo "Waiting for changedetection basic connectivity..."
          for i in {1..30}; do
            if curl -s -f http://localhost:5000/ > /dev/null; then
              echo "✅ Changedetection web interface is accessible"
              break
            fi
            echo "Waiting for basic connectivity... attempt $i/30"
            sleep 5
          done

      - name: Extract API key from changedetection datastore
        run: |
          echo "Extracting API key from changedetection..."
          CID=$(docker ps --filter "status=running" --format '{{.Names}}' | grep changedetection)
          
          # Wait for datastore file
          for i in {1..20}; do
            if docker exec $CID sh -c '[ -f /datastore/url-watches.json ]' 2>/dev/null; then
              break
            fi
            sleep 3
          done
          
          docker cp $CID:/datastore/url-watches.json url-watches.json || true
          
          if [ -f url-watches.json ]; then
            KEY=$(grep -oP '"api_access_token"\s*:\s*"\K[^"]+' url-watches.json || echo "")
            if [ -n "$KEY" ]; then
              echo "CHANGEDETECTION_API_KEY=$KEY" >> $GITHUB_ENV
              echo "API key extracted: ${KEY:0:8}..."
            else
              echo "WARNING: Could not extract API key from url-watches.json"
            fi
          fi

      - name: Test the exact API call
        run: |
          echo "=== Testing the exact API call that will be used ==="
          
          # Use extracted key or fallback to secret
          if [ -n "$CHANGEDETECTION_API_KEY" ]; then
            API_KEY="$CHANGEDETECTION_API_KEY"
            echo "Using extracted API key: ${API_KEY:0:8}..."
          else
            API_KEY="${{ secrets.CHANGEDETECTION_API_KEY }}"
            echo "Using secret API key: ${API_KEY:0:8}..."
          fi
          
          echo "--- Testing: curl -X GET http://localhost:5000/api/v1/watch -H 'x-api-key: XXX' ---"
          
          # Test with verbose output to see what's happening
          response=$(curl -v -X GET "http://localhost:5000/api/v1/watch" \
            -H "x-api-key: $API_KEY" \
            -w "\n%{http_code}" 2>&1)
          
          echo "--- Full Response ---"
          echo "$response"
          echo "--- End Response ---"
          
          # Extract HTTP status code
          http_code=$(echo "$response" | tail -1)
          echo "HTTP Status Code: $http_code"
          
          if [ "$http_code" = "200" ]; then
            echo "✅ API call successful!"
            exit 0
          else
            echo "❌ API call failed with HTTP $http_code"
            
            # Show what happens without API key
            echo "--- Testing without API key ---"
            curl -v -X GET "http://localhost:5000/api/v1/watch" 2>&1 | head -20
            
            # Test other endpoints
            echo "--- Testing /api/v1/version ---"
            curl -v -H "x-api-key: $API_KEY" "http://localhost:5000/api/v1/version" 2>&1 | head -20
            
            exit 1
          fi

      - name: Wait for API to be ready
        run: |
          echo "Waiting for API to be ready with the tested call..."
          
          if [ -n "$CHANGEDETECTION_API_KEY" ]; then
            API_KEY="$CHANGEDETECTION_API_KEY"
          else
            API_KEY="${{ secrets.CHANGEDETECTION_API_KEY }}"
          fi
          
          for i in {1..30}; do
            http_code=$(curl -s -o /dev/null -w "%{http_code}" \
              -X GET "http://localhost:5000/api/v1/watch" \
              -H "x-api-key: $API_KEY")
              
            if [ "$http_code" = "200" ]; then
              echo "✅ API is ready and responding correctly"
              exit 0
            fi
            
            echo "API returned HTTP $http_code, waiting... attempt $i/30"
            sleep 5
          done
          
          echo "❌ API never returned 200 status"
          docker compose -p $DOCKER_COMPOSE_PROJECT logs changedetection --tail=20
          exit 1
        
      - name: Prepare directories
        run: |
          mkdir -p data/reports logs
          chmod -R 777 data logs

      - name: Run monitoring cycle
        env:
          CHANGEDETECTION_API_KEY: ${{ secrets.CHANGEDETECTION_API_KEY }}
          GOOGLE_SHEETS_PRIVATE_KEY: ${{ secrets.GOOGLE_SHEETS_PRIVATE_KEY }}
        run: |
          set -e
          
          # Use the API key that we tested
          if [ -n "$CHANGEDETECTION_API_KEY" ]; then
            ACTUAL_API_KEY="$CHANGEDETECTION_API_KEY"
            echo "Using extracted API key: ${ACTUAL_API_KEY:0:8}..."
          else
            ACTUAL_API_KEY="$CHANGEDETECTION_API_KEY"
            echo "Using secret API key: ${ACTUAL_API_KEY:0:8}..."
          fi
          
          echo "Performing final health check with tested API call..."
          http_code=$(curl -s -o /dev/null -w "%{http_code}" \
            -X GET "http://localhost:5000/api/v1/watch" \
            -H "x-api-key: $ACTUAL_API_KEY")
            
          if [ "$http_code" = "200" ]; then
            echo "✅ Health check passed - API responding with 200"
          else
            echo "❌ Health check failed - API returned HTTP $http_code"
            exit 1
          fi
          
          for attempt in {1..3}; do
            echo "=== Monitoring Attempt $attempt/3 ==="
            
            if docker compose -p $DOCKER_COMPOSE_PROJECT run --rm \
              -e CHANGEDETECTION_API_KEY="$ACTUAL_API_KEY" \
              -e CHANGEDETECTION_URL=http://changedetection:5000 \
              -e GITHUB_ACTIONS=true \
              -e GITHUB_RUN_ID=${{ github.run_id }} \
              -e GITHUB_RUN_ATTEMPT=${{ github.run_attempt }} \
              -e GITHUB_SHA=${{ github.sha }} \
              -e GITHUB_REF=${{ github.ref }} \
              -e GOOGLE_SHEETS_USE_ENV=true \
              -e GOOGLE_SHEETS_TYPE=${{ secrets.GOOGLE_SHEETS_TYPE }} \
              -e GOOGLE_SHEETS_PROJECT_ID=${{ secrets.GOOGLE_SHEETS_PROJECT_ID }} \
              -e GOOGLE_SHEETS_PRIVATE_KEY_ID=${{ secrets.GOOGLE_SHEETS_PRIVATE_KEY_ID }} \
              -e GOOGLE_SHEETS_PRIVATE_KEY \
              -e GOOGLE_SHEETS_CLIENT_EMAIL=${{ secrets.GOOGLE_SHEETS_CLIENT_EMAIL }} \
              -e GOOGLE_SHEETS_CLIENT_ID=${{ secrets.GOOGLE_SHEETS_CLIENT_ID }} \
              -e GOOGLE_SHEETS_AUTH_URI=${{ secrets.GOOGLE_SHEETS_AUTH_URI }} \
              -e GOOGLE_SHEETS_TOKEN_URI=${{ secrets.GOOGLE_SHEETS_TOKEN_URI }} \
              -e GOOGLE_SHEETS_AUTH_PROVIDER_X509_CERT_URL=${{ secrets.GOOGLE_SHEETS_AUTH_PROVIDER_X509_CERT_URL }} \
              -e GOOGLE_SHEETS_CLIENT_X509_CERT_URL=${{ secrets.GOOGLE_SHEETS_CLIENT_X509_CERT_URL }} \
              -e MONITOR_RUN_TYPE=${{ github.event.inputs.run_type || 'standard' }} \
              metadata-monitor python run_monitor.py; then
              
              echo "✅ Monitoring completed successfully on attempt $attempt"
              break
            else
              echo "❌ Monitoring failed on attempt $attempt"
              if [ $attempt -lt 3 ]; then
                echo "Retrying in 15 seconds..."
                sleep 15
                docker compose -p $DOCKER_COMPOSE_PROJECT restart changedetection
                sleep 10
              else
                exit 1
              fi
            fi
          done

      - name: Upload monitoring reports
        uses: actions/upload-artifact@v4
        with:
          name: monitoring-reports-${{ github.run_id }}
          path: data/reports/
          retention-days: 30
          if-no-files-found: warn

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: monitor-logs-${{ github.run_id }}
          path: logs/
          retention-days: 7
          if-no-files-found: ignore

      - name: Save service logs
        if: always()
        run: |
          mkdir -p docker-logs
          docker compose -p $DOCKER_COMPOSE_PROJECT logs changedetection > docker-logs/changedetection.log 2>&1 || true
          docker compose -p $DOCKER_COMPOSE_PROJECT logs playwright-chrome > docker-logs/playwright.log 2>&1 || true

      - name: Upload service logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: service-logs-${{ github.run_id }}
          path: docker-logs/
          retention-days: 7

      - name: Tear down services
        if: always()
        run: |
          docker compose -p $DOCKER_COMPOSE_PROJECT down --remove-orphans

      - name: Create workflow summary
        if: always()
        run: |
          echo "## AI Safety Monitor Run Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run Details:**" >> $GITHUB_STEP_SUMMARY
          echo "- **Type:** ${{ github.event.inputs.run_type || 'standard' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${GITHUB_SHA:0:8}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Artifacts:**" >> $GITHUB_STEP_SUMMARY
          echo "- Monitoring reports" >> $GITHUB_STEP_SUMMARY
          echo "- Application logs" >> $GITHUB_STEP_SUMMARY
          echo "- Service logs" >> $GITHUB_STEP_SUMMARY