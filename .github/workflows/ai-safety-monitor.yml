name: AI Safety Monitor - Metadata Only

on:
  schedule:
    - cron: '0 0 * * *'  # Run every day at 00:00 UTC
  workflow_dispatch:
    inputs:
      run_type:
        description: 'Type of run'
        required: true
        default: 'standard'
        type: choice
        options:
          - standard
          - verbose
          - debug

env:
  DOCKER_COMPOSE_PROJECT: ai-safety-monitor-${{ github.run_number }}
  DOCKER_LOG_DIR: docker-logs

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Restore data cache
        uses: actions/cache@v4
        id: data-cache
        with:
          path: data/
          key: monitoring-data-${{ runner.os }}-v1
          restore-keys: |
            monitoring-data-${{ runner.os }}-v1

      - name: Ensure data directories exist and set FIRST_RUN
        id: prepare-data
        run: |
          mkdir -p data/datastore data/reports data/logs
          # Ensure the runner and any containers can write to these dirs
          chmod -R 0777 data || true
          if [ -s data/url_history.json ]; then
            echo "FIRST_RUN=false" >> $GITHUB_ENV
            echo "first_run=false" >> $GITHUB_OUTPUT
          else
            echo "FIRST_RUN=true" >> $GITHUB_ENV
            echo "first_run=true" >> $GITHUB_OUTPUT
          fi

      - name: Setup environment (safe source)
        run: |
          if [ -f .github/scripts/config.sh ]; then
            set -a
            # shellcheck disable=SC1091
            source .github/scripts/config.sh
            set +a
          fi

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Ensure cache directories
        run: |
          mkdir -p ~/.cache/pip /tmp/pip-cache ~/.cache/docker
          touch ~/.cache/pip/.keep || true

      - name: Cache Python packages
        uses: actions/cache@v4
        id: pip-cache
        with:
          path: |
            ~/.cache/pip
            /tmp/pip-cache
            **/.pytest_cache
          key: ${{ runner.os }}-python-${{ hashFiles('**/requirements.txt') }}-v1
          restore-keys: |
            ${{ runner.os }}-python-

      - name: Build and start services
        run: |
          source .github/scripts/logger.sh

          # Determine docker compose command (plugin or legacy) and export to env
          if docker compose version >/dev/null 2>&1; then
            DOCKER_COMPOSE_CMD='docker compose'
          elif command -v docker-compose >/dev/null 2>&1; then
            DOCKER_COMPOSE_CMD='docker-compose'
          else
            echo 'docker compose not available' >&2
            exit 1
          fi
          echo "DOCKER_COMPOSE_CMD=$DOCKER_COMPOSE_CMD" >> $GITHUB_ENV

          log_info "Building metadata-monitor image with cache..."
          $DOCKER_COMPOSE_CMD --progress=plain build --build-arg BUILDKIT_INLINE_CACHE=1 metadata-monitor

          log_info "Starting metadata-monitor service..."
          $DOCKER_COMPOSE_CMD -p $DOCKER_COMPOSE_PROJECT up -d metadata-monitor

          log_success "metadata-monitor started successfully"

      - name: Run monitoring container
        run: |
          # Determine docker compose command (plugin or legacy)
          if docker compose version >/dev/null 2>&1; then
            DOCKER_COMPOSE_CMD='docker compose'
          elif command -v docker-compose >/dev/null 2>&1; then
            DOCKER_COMPOSE_CMD='docker-compose'
          else
            echo 'docker compose not available' >&2
            exit 1
          fi

          # Ensure service is running
          $DOCKER_COMPOSE_CMD --progress=plain -p "$DOCKER_COMPOSE_PROJECT" build --parallel metadata-monitor
          $DOCKER_COMPOSE_CMD -p "$DOCKER_COMPOSE_PROJECT" up -d metadata-monitor

          CONTAINER_ID=$($DOCKER_COMPOSE_CMD -p "$DOCKER_COMPOSE_PROJECT" ps -q metadata-monitor || true)
          if [ -z "$CONTAINER_ID" ]; then
            echo 'metadata-monitor container failed to start' >&2
            exit 1
          fi

          # Run the monitor once; keep mounts minimal for speed
          # Pass GitHub Secrets directly into the container at runtime
          # to avoid persisting the private key on the runner.
          $DOCKER_COMPOSE_CMD -p "$DOCKER_COMPOSE_PROJECT" run --rm \
            -e GOOGLE_SHEETS_TYPE="${{ secrets.GOOGLE_SHEETS_TYPE }}" \
            -e GOOGLE_SHEETS_PROJECT_ID="${{ secrets.GOOGLE_SHEETS_PROJECT_ID }}" \
            -e GOOGLE_SHEETS_PRIVATE_KEY_ID="${{ secrets.GOOGLE_SHEETS_PRIVATE_KEY_ID }}" \
            -e GOOGLE_SHEETS_PRIVATE_KEY="${{ secrets.GOOGLE_SHEETS_PRIVATE_KEY }}" \
            -e GOOGLE_SHEETS_CLIENT_EMAIL="${{ secrets.GOOGLE_SHEETS_CLIENT_EMAIL }}" \
            -e GOOGLE_SHEETS_CLIENT_ID="${{ secrets.GOOGLE_SHEETS_CLIENT_ID }}" \
            -v "$(pwd)/data:/app/data" \
            -v "$(pwd)/${REPORT_DIR:-data/reports}:/app/data/reports" \
            metadata-monitor python run_monitor.py
      - name: Save service logs
        if: always()
        run: |
          mkdir -p "$DOCKER_LOG_DIR"
          docker compose -p "$DOCKER_COMPOSE_PROJECT" logs metadata-monitor > "$DOCKER_LOG_DIR/metadata-monitor.log" 2>&1 || true
          docker compose -p "$DOCKER_COMPOSE_PROJECT" logs metadata-monitor > "${{ env.DOCKER_LOG_DIR || 'docker-logs' }}/metadata-monitor.log" 2>&1 || true

      - name: Upload monitoring reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: monitoring-reports-${{ github.run_number }}
          path: data/reports/
          retention-days: 30
          if-no-files-found: warn
      - name: Upload service logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: service-logs-${{ github.run_number }}
          path: ${{ env.DOCKER_LOG_DIR }}
          retention-days: 7
          if-no-files-found: ignore

      - name: Cleanup services (preserve data)
        if: always()
        run: |
          docker compose -p "$DOCKER_COMPOSE_PROJECT" down --remove-orphans --timeout 30 || true

      - name: Create workflow summary
        if: always()
        run: |
          echo "## AI Safety Monitor Run Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Type: ${{ github.event.inputs.run_type || 'standard' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- First run: ${{ steps.prepare-data.outputs.first_run }}" >> $GITHUB_STEP_SUMMARY