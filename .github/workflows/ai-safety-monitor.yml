name: AI Safety Monitor

on:
  schedule:
    - cron: '0 */6 * * *'  # Run every 6 hours
  workflow_dispatch:
    inputs:
      run_type:
        description: 'Type of run'
        required: true
        default: 'standard'
        type: choice
        options:
          - standard
          - verbose
          - debug

env:
  DOCKER_COMPOSE_PROJECT: ai-safety-monitor-${{ github.run_id }}

jobs:
  monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-docker-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-docker-

      - name: Build and start services
        run: |
          docker compose build metadata-monitor
          docker compose -p $DOCKER_COMPOSE_PROJECT up -d changedetection playwright-chrome

      - name: Wait for basic connectivity
        run: |
          echo "Waiting for changedetection basic connectivity..."
          for i in {1..30}; do
            if curl -s -f http://localhost:5000/ > /dev/null; then
              echo "✅ Changedetection web interface is accessible"
              break
            fi
            echo "Waiting for basic connectivity... attempt $i/30"
            sleep 5
          done

      - name: Extract API key from changedetection datastore
        run: |
          echo "Extracting API key from changedetection..."
          CID=$(docker ps --filter "status=running" --filter "name=.*changedetection" \
            --format '{{.Names}}' | head -1)
          if [ -z "$CID" ]; then
            echo "❌ ERROR: changedetection container not found"
            exit 1
          fi
          
          # Wait for datastore file
          for i in {1..20}; do
            if docker exec $CID sh -c '[ -f /datastore/url-watches.json ]' 2>/dev/null; then
              break
            fi
            sleep 3
          done
          
          if ! docker cp $CID:/datastore/url-watches.json url-watches.json; then
            echo "❌ ERROR: Failed to extract datastore"
            exit 1
          fi
          
          if [ -f url-watches.json ]; then
            KEY=$(grep -oP '"api_access_token"\s*:\s*"\K[^"]+' url-watches.json || echo "")
            if [ -n "$KEY" ]; then
              echo "CHANGEDETECTION_API_KEY=$KEY" >> $GITHUB_ENV
              echo "API key extracted."
            else
              echo "❌ ERROR: Could not extract API key from url-watches.json"
              exit 1
            fi
          else
            echo "❌ ERROR: url-watches.json not found in datastore"
            exit 1
          fi

      - name: Test systeminfo endpoint
        run: |
          echo "=== Testing systeminfo endpoint ==="
          
          API_KEY="$CHANGEDETECTION_API_KEY"
          echo "Using extracted API key: ${API_KEY:0:8}..."
          
          echo "--- Testing: curl -X GET http://localhost:5000/api/v1/systeminfo -H 'x-api-key: XXX' ---"
          
          # Test systeminfo endpoint with verbose output
          response=$(curl -v -X GET "http://localhost:5000/api/v1/systeminfo" \
            -H "x-api-key: $API_KEY" \
            -w "\n%{http_code}" 2>&1)
          
          echo "--- Full Response ---"
          echo "$response"
          echo "--- End Response ---"
          
          # Extract HTTP status code
          http_code=$(echo "$response" | tail -1)
          echo "HTTP Status Code: $http_code"
          
          if [ "$http_code" = "200" ]; then
            echo "✅ systeminfo endpoint successful!"
            exit 0
          else
            echo "❌ systeminfo endpoint returned HTTP $http_code"
            
            # Test other potential endpoints
            echo "--- Testing other endpoints ---"
            endpoints=("/api/v1/version" "/api/v1/overview" "/api/v1/")
            for endpoint in "${endpoints[@]}"; do
              echo "Testing $endpoint:"
              curl -s -o /dev/null -w "%{http_code}" -H "x-api-key: $API_KEY" "http://localhost:5000$endpoint" | xargs echo "HTTP"
            done
            exit 1
          fi

      - name: Wait for API to be ready
        run: |
          echo "Waiting for API to be ready using systeminfo endpoint..."
          
          API_KEY="$CHANGEDETECTION_API_KEY"
          
          for i in {1..30}; do
            http_code=$(curl -s -o /dev/null -w "%{http_code}" \
              -X GET "http://localhost:5000/api/v1/systeminfo" \
              -H "x-api-key: $API_KEY")
              
            if [ "$http_code" = "200" ]; then
              echo "✅ API is ready and responding correctly via systeminfo"
              exit 0
            fi
            
            echo "systeminfo returned HTTP $http_code, waiting... attempt $i/30"
            sleep 5
          done
          
          echo "❌ API never returned 200 status on systeminfo"
          docker compose -p $DOCKER_COMPOSE_PROJECT logs changedetection --tail=20
          exit 1
        
      - name: Prepare directories
        run: |
          mkdir -p data/reports logs
          chmod -R 777 data logs

      - name: Run monitoring cycle
        run: |
          set -e
          
          # Use ONLY the extracted API key from datastore
          ACTUAL_API_KEY="$CHANGEDETECTION_API_KEY"
          echo "Using extracted API key: ${ACTUAL_API_KEY:0:8}..."
          
          echo "Performing final health check with tested API call..."
          http_code=$(curl -s -o /dev/null -w "%{http_code}" \
            -X GET "http://localhost:5000/api/v1/watch" \
            -H "x-api-key: $ACTUAL_API_KEY")
            
          if [ "$http_code" = "200" ]; then
            echo "✅ Health check passed - API responding with 200"
          else
            echo "❌ Health check failed - API returned HTTP $http_code"
            exit 1
          fi
          
          for attempt in {1..3}; do
            echo "=== Monitoring Attempt $attempt/3 ==="
            
            if docker compose -p $DOCKER_COMPOSE_PROJECT run --rm \
              -e CHANGEDETECTION_API_KEY="$ACTUAL_API_KEY" \
              -e CHANGEDETECTION_URL=http://changedetection:5000 \
              -e GITHUB_ACTIONS=true \
              -e GITHUB_RUN_ID=${{ github.run_id }} \
              -e GITHUB_RUN_ATTEMPT=${{ github.run_attempt }} \
              -e GITHUB_SHA=${{ github.sha }} \
              -e GITHUB_REF=${{ github.ref }} \
              -e MONITOR_RUN_TYPE=${{ github.event.inputs.run_type || 'standard' }} \
              metadata-monitor python run_monitor.py; then
              
              echo "✅ Monitoring completed successfully on attempt $attempt"
              break
            else
              echo "❌ Monitoring failed on attempt $attempt"
              if [ $attempt -lt 3 ]; then
                echo "Retrying in 15 seconds..."
                sleep 15
                docker compose -p $DOCKER_COMPOSE_PROJECT restart changedetection
                sleep 10
              else
                exit 1
              fi
            fi
          done

      - name: Upload monitoring reports
        uses: actions/upload-artifact@v4
        with:
          name: monitoring-reports-${{ github.run_id }}
          path: data/reports/
          retention-days: 30
          if-no-files-found: warn

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: monitor-logs-${{ github.run_id }}
          path: logs/
          retention-days: 7
          if-no-files-found: ignore

      - name: Save service logs
        if: always()
        run: |
          mkdir -p docker-logs
          docker compose -p $DOCKER_COMPOSE_PROJECT logs changedetection > docker-logs/changedetection.log 2>&1 || true
          docker compose -p $DOCKER_COMPOSE_PROJECT logs playwright-chrome > docker-logs/playwright.log 2>&1 || true

      - name: Upload service logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: service-logs-${{ github.run_id }}
          path: docker-logs/
          retention-days: 7

      - name: Tear down services
        if: always()
        run: |
          docker compose -p $DOCKER_COMPOSE_PROJECT down --remove-orphans

      - name: Create workflow summary
        if: always()
        run: |
          echo "## AI Safety Monitor Run Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run Details:**" >> $GITHUB_STEP_SUMMARY
          echo "- **Type:** ${{ github.event.inputs.run_type || 'standard' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${GITHUB_SHA:0:8}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Artifacts:**" >> $GITHUB_STEP_SUMMARY
          echo "- Monitoring reports" >> $GITHUB_STEP_SUMMARY
          echo "- Application logs" >> $GITHUB_STEP_SUMMARY
          echo "- Service logs" >> $GITHUB_STEP_SUMMARY