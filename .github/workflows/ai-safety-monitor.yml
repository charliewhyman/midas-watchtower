name: AI Safety Monitor

on:
  schedule:
    - cron: '0 */6 * * *'  # Run every 6 hours
  workflow_dispatch:
    inputs:
      run_type:
        description: 'Type of run'
        required: true
        default: 'standard'
        type: choice
        options:
        - standard
        - verbose
        - debug

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install core dependencies
      run: |
        python -m pip install --upgrade pip
        pip install fastapi==0.104.1 uvicorn==0.24.0 requests==2.31.0
        pip install pyyaml==6.0.1 schedule==1.2.0 gspread==5.11.0 google-auth==2.23.4
        
    - name: Initialize data directory
      run: |
        mkdir -p data logs
        echo "Data directory structure created"
        
    - name: Check for and download previous history
      id: download-history
      continue-on-error: true
      uses: actions/download-artifact@v4
      with:
        name: url-history
        path: ./data/
        
    - name: Create initial history file
      if: steps.download-history.outcome == 'failure'
      run: |
        echo "Creating initial URL history file (first run or artifact expired)"
        echo '{}' > data/url_history.json
        echo "✓ Created initial url_history.json"
        
    - name: Verify history file exists
      run: |
        echo "Verifying URL history file..."
        if [ -f "data/url_history.json" ]; then
          echo "✓ url_history.json exists"
          echo "File size: $(wc -c < data/url_history.json) bytes"
          echo "File content preview:"
          head -c 200 data/url_history.json
          echo ""
        else
          echo "✗ url_history.json missing - creating now"
          echo '{}' > data/url_history.json
        fi
        
    - name: Run monitoring cycle
      env:
        CHANGEDETECTION_URL: "http://localhost:5000"
        CHANGEDETECTION_API_KEY: ${{ secrets.CHANGEDETECTION_API_KEY }}
        GITHUB_ACTIONS: 'true'
        MONITOR_RUN_TYPE: ${{ github.event.inputs.run_type }}
        GOOGLE_SHEETS_USE_ENV: 'true'
        GOOGLE_SHEETS_TYPE: ${{ secrets.GOOGLE_SHEETS_TYPE }}
        GOOGLE_SHEETS_PROJECT_ID: ${{ secrets.GOOGLE_SHEETS_PROJECT_ID }}
        GOOGLE_SHEETS_PRIVATE_KEY_ID: ${{ secrets.GOOGLE_SHEETS_PRIVATE_KEY_ID }}
        GOOGLE_SHEETS_PRIVATE_KEY: ${{ secrets.GOOGLE_SHEETS_PRIVATE_KEY }}
        GOOGLE_SHEETS_CLIENT_EMAIL: ${{ secrets.GOOGLE_SHEETS_CLIENT_EMAIL }}
        GOOGLE_SHEETS_CLIENT_ID: ${{ secrets.GOOGLE_SHEETS_CLIENT_ID }}
        GOOGLE_SHEETS_AUTH_URI: ${{ secrets.GOOGLE_SHEETS_AUTH_URI }}
        GOOGLE_SHEETS_TOKEN_URI: ${{ secrets.GOOGLE_SHEETS_TOKEN_URI }}
        GOOGLE_SHEETS_AUTH_PROVIDER_X509_CERT_URL: ${{ secrets.GOOGLE_SHEETS_AUTH_PROVIDER_X509_CERT_URL }}
        GOOGLE_SHEETS_CLIENT_X509_CERT_URL: ${{ secrets.GOOGLE_SHEETS_CLIENT_X509_CERT_URL }}
      run: |
        echo "Starting monitoring cycle..."
        python monitor.py
        echo "Monitoring cycle completed"
        
    - name: Show monitoring logs
      if: always()
      run: |
        echo "=== RECENT MONITOR LOGS ==="
        if [ -f "logs/monitor.log" ]; then
          tail -50 logs/monitor.log
        else
          echo "No monitor.log file found"
        fi
        
    - name: Upload URL history artifact
      uses: actions/upload-artifact@v4
      with:
        name: url-history
        path: /data/url_history.json
        retention-days: 30
        
    - name: Upload monitoring reports
      uses: actions/upload-artifact@v4
      with:
        name: monitoring-reports
        path: /data/reports/
        retention-days: 30
        if-no-files-found: ignore
        
    - name: Upload logs for debugging
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: monitor-logs
        path: /logs/
        retention-days: 7
        if-no-files-found: ignore
        
    - name: Create workflow summary
      if: always()
      run: |
        echo "## AI Safety Monitor Run Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Run Details:**" >> $GITHUB_STEP_SUMMARY
        echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Run Type**: ${{ github.event.inputs.run_type || 'standard' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Timestamp**: $(date -u)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Check if history was downloaded or created new
        if [ -f "data/url_history.json" ]; then
          HISTORY_SIZE=$(wc -c < data/url_history.json)
          if [ $HISTORY_SIZE -lt 10 ]; then
            echo "**History**: Created new (first run)" >> $GITHUB_STEP_SUMMARY
          else
            echo "**History**: Loaded existing ($HISTORY_SIZE bytes)" >> $GITHUB_STEP_SUMMARY
          fi
        fi
        
        # Check Google Sheets status from logs
        if [ -f "logs/monitor.log" ]; then
          if grep -q "Google Sheets client authorized successfully" logs/monitor.log; then
            echo "**Google Sheets**: ✅ Enabled and connected" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Google Sheets**: ❌ Disabled or connection failed" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "**Google Sheets**: ⚠ Status unknown (no logs)" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Show recent changes if log exists
        if [ -f "logs/monitor.log" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Recent Activity:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -10 logs/monitor.log | grep -E "(changes detected|Starting monitoring cycle|Monitoring cycle completed)" >> $GITHUB_STEP_SUMMARY || echo "No recent activity found" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi