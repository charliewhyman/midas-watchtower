name: AI Safety Monitor

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      run_type:
        description: 'Type of run'
        required: true
        default: 'standard'
        type: choice
        options:
          - standard
          - verbose
          - debug

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Build metadata-monitor image
      - name: Build metadata-monitor image
        run: docker compose build metadata-monitor

      # Bring up dependent services
      - name: Start changedetection.io and Playwright
        run: docker compose up -d changedetection playwright-chrome

      # Wait for changedetection.io to be ready
      - name: Wait for changedetection.io
        run: |
          for i in {1..12}; do
            if curl -s http://localhost:5000; then
              echo "Changedetection ready"
              exit 0
            fi
            echo "Waiting for changedetection..."
            sleep 10
          done
          echo "Changedetection never became ready"
          exit 1

      # Run monitoring cycle with retries
      - name: Run monitoring cycle
        env:
          CHANGEDETECTION_API_KEY: ${{ secrets.CHANGEDETECTION_API_KEY }}
          CHANGEDETECTION_URL: http://changedetection:5000
          GOOGLE_SHEETS_USE_ENV: 'true'
          GOOGLE_SHEETS_TYPE: ${{ secrets.GOOGLE_SHEETS_TYPE }}
          GOOGLE_SHEETS_PROJECT_ID: ${{ secrets.GOOGLE_SHEETS_PROJECT_ID }}
          GOOGLE_SHEETS_PRIVATE_KEY_ID: ${{ secrets.GOOGLE_SHEETS_PRIVATE_KEY_ID }}
          GOOGLE_SHEETS_PRIVATE_KEY: ${{ secrets.GOOGLE_SHEETS_PRIVATE_KEY }}
          GOOGLE_SHEETS_CLIENT_EMAIL: ${{ secrets.GOOGLE_SHEETS_CLIENT_EMAIL }}
          GOOGLE_SHEETS_CLIENT_ID: ${{ secrets.GOOGLE_SHEETS_CLIENT_ID }}
          GOOGLE_SHEETS_AUTH_URI: ${{ secrets.GOOGLE_SHEETS_AUTH_URI }}
          GOOGLE_SHEETS_TOKEN_URI: ${{ secrets.GOOGLE_SHEETS_TOKEN_URI }}
          GOOGLE_SHEETS_AUTH_PROVIDER_X509_CERT_URL: ${{ secrets.GOOGLE_SHEETS_AUTH_PROVIDER_X509_CERT_URL }}
          GOOGLE_SHEETS_CLIENT_X509_CERT_URL: ${{ secrets.GOOGLE_SHEETS_CLIENT_X509_CERT_URL }}
          MONITOR_RUN_TYPE: ${{ github.event.inputs.run_type }}
        run: |
          for attempt in {1..3}; do
            echo "Attempt $attempt to run monitoring container..."
            docker compose run --rm metadata-monitor python - <<'PYTHON'
            from monitoring_service import MonitoringService
            service = MonitoringService(config_path="config.yaml")
            stats = service.run_cycle()
            print(f"Cycle {stats.cycle_id} completed: {stats.changes_detected} changes detected")
            PYTHON
            if [ $? -eq 0 ]; then
              echo "Monitoring completed successfully."
              break
            else
              echo "Monitoring failed, retrying in 10s..."
              sleep 10
            fi
          done

      # Upload monitoring reports
      - name: Upload monitoring reports
        uses: actions/upload-artifact@v4
        with:
          name: monitoring-reports
          path: data/reports/
          retention-days: 30
          if-no-files-found: ignore

      # Upload logs
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: monitor-logs
          path: logs/
          retention-days: 7
          if-no-files-found: ignore

      # Tear down services
      - name: Tear down services
        if: always()
        run: docker compose down

      # Workflow summary
      - name: Create workflow summary
        if: always()
        run: |
          echo "## AI Safety Monitor Run Complete" >> $GITHUB_STEP_SUMMARY
          echo "- Run Type: ${{ github.event.inputs.run_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Timestamp: $(date -u)" >> $GITHUB_STEP_SUMMARY